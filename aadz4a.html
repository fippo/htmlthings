<button id="play">play noise</button>
<audio id="audioElement"></audio>
<button id="gum">request getusermedia (then deny)</button>
<button id="getsettings">check track settings</button>
<div id="err"></div>
<script>
const el = document.getElementById('audioElement');

const pc1 = new RTCPeerConnection();
const pc2 = new RTCPeerConnection();
pc1.onicecandidate = e => pc2.addIceCandidate(e.candidate);
pc2.onicecandidate = e => pc1.addIceCandidate(e.candidate);
pc2.ontrack = e => {
  el.srcObject = e.streams[0];
  el.play().catch(e => {
   document.getElementById('err').innerText += '\n' + e.toString();
  });
};

const trackFactories = {
  audioContext: null,

  audio() {
    const ctx = trackFactories.audioContext = trackFactories.audioContext ||
      new (window.AudioContext ||window.webkitAudioContext)();
    const oscillator = ctx.createOscillator();
    const dst = oscillator.connect(ctx.createMediaStreamDestination());
    oscillator.start();
    return dst.stream;
  },  
};
document.getElementById('play').addEventListener('click', async () => {
  el.play().catch(e => {
   document.getElementById('err').innerText += '\n' + e.toString();
  });
  document.getElementById('err').innerText += '\nstarting';
  const stream = trackFactories.audio();
  pc1.addTrack(stream.getTracks()[0], stream);
  const offer = await pc1.createOffer();
  await pc2.setRemoteDescription(offer);
  await pc1.setLocalDescription(offer);

  const answer = await pc2.createAnswer();
  await pc1.setRemoteDescription(answer);
  await pc2.setLocalDescription(answer);

  document.getElementById('err').innerText += '\establishing...';
  pc1.oniceconnectionstatechange = () => {
    document.getElementById('err').innerText += '\nICE ' + pc1.iceConnectionState;
  };
});
document.getElementById('gum').addEventListener('click', async () => {
  try {
    await navigator.mediaDevices.getUserMedia({audio: true});
  } catch(e) {
    document.getElementById('err').innerText += '\n' + e.toString();
  };
});

document.getElementById('getsettings').addEventListener('click', async () => {
  const track = pc2.getReceivers()[0].track;
  document.getElementById('err').innerText += '\n' + JSON.stringify(track.getSettings(), null, ' ');
});
</script>
